## Machine Node

Запускается в единственном экземпляре на каждом сервере, служит для запуска/контроля/отключения действий на конкретном сервере. Основная задача Machine Node — связывать Meta Node и Runtime на конкретном сервере кластера. Кроме того, Machine Node ответственен за запуск и остановку действий.

Для получения команд от MetaNode узел выступает в роли HTTP-сервера со следующими методами:
* метод `/run` позволяет запустить действие на сервере, в теле запроса передаются:
  * уникальное в системе название графа обработки данных;
  * уникальное в текущем графе обработки данных название узла;
  * название пользовательского действия для запуска;
  * порт, на котором runtime должен ожидать сообщения;
  * набор имен связанных вышестоящих узлов;
  * набор адресов связанных нижестоящих узлов;
  * аргументы командной строки и переменные окружения для запуска действия;
* метод `/stop` используется для остановки действия на сервере, в теле запроса передаются название графа обработки данных и название узла;
* метод `/change_out` передает указанному узлу и графа обработки данных команду `change_out`, значение которой описано в разделе про Meta Node [тут](./meta_node.md);
* метод `/ping` возвращает MetaNode список работающих на сервере действий, а также информацию о состоянии их runtime.

Для того, чтобы запущенное действие было признано неработающим, должно быть превышено время ожидания ответа от runtime на команду `ping` `N`, где `N` в конфигурации.

### Конфигурация

Пример конфигурации можно посмотреть [тут](../../../examples/configs/meta_node_config.yaml).

| Параметр      | Значение по умолчанию | Описание |
| ------------- | ------------- | ----- |
| http.host | 0.0.0.0 | хост, на котором запускается сервисный сервер, указывается в конфигурации meta_node |
| http.port | 8080 | порт, на котором запускается сервисный сервер, указывается в конфигурации meta_node |
| logging.logfile | stdout | Имя файла для логирования или же stdout для записи в консоль |
| logging.level | info | Уровень логирования |
| logging.truncate-file | false | Если true, очищает файл перед началом записи логов при включении |
| etcd.endpoints | [] | Список адресов узлов etcd в формате `host:port` |
| etcd.timeout | 1m | Таймаут при обращении к etcd |
| etcd.retry.delay | 1s | Задержка между попытками обращения к etcd |
| etcd.retry.count | 5 | количество попыток обращения к etcd |
| watcher.pings-to-stop | 3 | количество непрошедших ping к действию, для признания его неработающим |
| watcher.ping-freq | 5s | время между запросами к действия для получения информации их состоянии |
| runtime.action-start-retry.delay | 1s | задержка между начальными ping, для признания действия запущенным |
| runtime.action-start-retry.count | 5 | количество запросов к действию, для проверки запуска |
| runtime.binary-path | runtime | путь к бинарному файлу рантайма |
| runtime.logs-dir | runtime-logs | путь к папке с логами рантаймов |
| runtime.logs-level | info | уровень логирования рантаймов |
| runtime.timeout | 5s | таймаут на операции с рантаймом |
| runtime.ack-period | 5s | частота отправки ack сообщений у создаваемых рантаймов |
| runtime.forward-log-dir | /tmp/gostreaming-log | директория для записи |
